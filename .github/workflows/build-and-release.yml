name: Build and Release WPE WebKit

on:
  push:
    branches:
      - '**'
    paths:
      - '.github/workflows/**'
      - 'build.sh'
    tags:
      - 'v*'

jobs:
  build_and_package:
    name: Build and Package
    runs-on: ubuntu-latest
    outputs:
      package_name: ${{ steps.package.outputs.name }}
      package_path: ${{ steps.package.outputs.path }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-${{ hashFiles('build.sh') }}
          restore-keys: |
            ${{ runner.os }}-ccache-

      - name: Run build script
        run: |
          chmod +x build.sh
          ./build.sh

      - name: Prepare for packaging
        id: prep
        run: |
          # Create a staging directory for the package contents
          mkdir -p staging/usr/
          # The script installed everything into /usr/local. We copy it to our staging dir.
          # GitHub runners are clean, so /usr/local should only contain our stuff.
          cp -r /usr/local/* staging/usr/

          mkdir -p staging/DEBIAN
          
          VERSION="dev-${GITHUB_SHA::7}"
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            VERSION="${{ github.ref_name }}"
          fi
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

          # This is a simplified approach for dependencies. For a robust solution,
          # consider using dpkg-shlibdeps to automatically determine dependencies.
          DEPS="libc6, libglib2.0-0, libsoup-3.0-0, libharfbuzz0b, libicu70, libgstreamer1.0-0"

          cat <<EOF > staging/DEBIAN/control
          Package: wpe-webkit
          Version: ${VERSION#v}
          Architecture: amd64
          Maintainer: Mumulhl <mumulhl.666@gmail.com>
          Description: A custom build of WPE WebKit.
          Depends: ${DEPS}
          EOF

      - name: Build .deb package
        id: package
        run: |
          PACKAGE_NAME="wpe-webkit-${VERSION#v}_amd64.deb"
          dpkg-deb --build staging "${PACKAGE_NAME}"
          echo "name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "path=${PACKAGE_NAME}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-package
          path: ${{ steps.package.outputs.path }}

  create_release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: build_and_package
    if: github.ref_type == 'tag'
    permissions:
      contents: write

    steps:
      - name: Download .deb package from build job
        uses: actions/download-artifact@v4
        with:
          name: deb-package
          # The artifact is downloaded to the root of the workspace
          path: .

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ needs.build_and_package.outputs.package_path }}
          name: Release ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          body: "Automated release of WPE WebKit custom build."
